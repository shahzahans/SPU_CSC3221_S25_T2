<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Form</title>
  
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Create User</h1>
    <form id="userForm">
        <label for="name">Name:</label>
        <input type="text" id="name" required>

        <label for="username">Username:</label>
        <input type="text" id="username" required>

        <label for="email">Email:</label>
        <input type="email" id="email">

        <label for="phone">Phone:</label>
        <input type="text" id="phone">

        <label for="website">Website:</label>
        <input type="text" id="website">

        <label for="street">Street:</label>
        <input type="text" id="street">

        <label for="suite">Suite:</label>
        <input type="text" id="suite">

        <label for="city">City:</label>
        <input type="text" id="city">

        <label for="zipcode">Zipcode:</label>
        <input type="text" id="zipcode">

        <label for="lat">Latitude:</label>
        <input type="text" id="lat">

        <label for="lng">Longitude:</label>
        <input type="text" id="lng">

        <label for="companyName">Company Name:</label>
        <input type="text" id="companyName">

        <label for="catchPhrase">Catch Phrase:</label>
        <input type="text" id="catchPhrase">

        <label for="bs">BS:</label>
        <input type="text" id="bs">

        <button type="submit">Submit</button>
    </form>

    <h2>All Users</h2>
    <ul id="userList"></ul>

    <div id="userModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #ccc; padding:20px; z-index:1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 500px; overflow-y: auto; max-height: 80vh;">
    <button id="closeModal" style="float:right;">X</button>
    <form id="userEditForm">
      <label>Name: <input type="text" id="modalName" readonly></label>
      <label>Username: <input type="text" id="modalUsername" readonly></label>
      <label>Email: <input type="text" id="modalEmail" readonly></label>
      <label>Phone: <input type="text" id="modalPhone" readonly></label>
      <label>Website: <input type="text" id="modalWebsite" readonly></label>
      <fieldset>
        <legend>Address:</legend>
        <label>Street: <input type="text" id="modalStreet" readonly></label>
        <label>Suite: <input type="text" id="modalSuite" readonly></label>
        <label>City: <input type="text" id="modalCity" readonly></label>
        <label>Zipcode: <input type="text" id="modalZipcode" readonly></label>
        <label>Lat: <input type="text" id="modalLat" readonly></label>
        <label>Lng: <input type="text" id="modalLng" readonly></label>
      </fieldset>
      <fieldset>
        <legend>Company:</legend>
        <label>Name: <input type="text" id="modalCompanyName" readonly></label>
        <label>Catch Phrase: <input type="text" id="modalCatchPhrase" readonly></label>
        <label>BS: <input type="text" id="modalBS" readonly></label>
      </fieldset>
    </form>
    <button id="editUser">Edit</button>
    <button id="deleteUser">Delete</button>
  </div>
  <div id="modalBackdrop" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:999;"></div>
  
    <script>
        const form = document.getElementById('userForm');
        const userList = document.getElementById('userList');
        let currentUserId = null;

        async function fetchUsers() {
            try {
                const res = await fetch('http://localhost:3000/users');
                const data = await res.json();
                userList.innerHTML = '';
                data.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = `${user.name} (${user.username})`;
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', async () => {
                        try {
                            currentUserId = user.id;
                            const res = await fetch(`http://localhost:3000/users/${user.id}`);
                            const data = await res.json();
                            document.getElementById('modalName').value = data.name;
                            document.getElementById('modalUsername').value = data.username;
                            document.getElementById('modalEmail').value = data.email;
                            document.getElementById('modalPhone').value = data.phone;
                            document.getElementById('modalWebsite').value = data.website;
                            document.getElementById('modalStreet').value = data.address.street;
                            document.getElementById('modalSuite').value = data.address.suite;
                            document.getElementById('modalCity').value = data.address.city;
                            document.getElementById('modalZipcode').value = data.address.zipcode;
                            document.getElementById('modalLat').value = data.address.geo.lat;
                            document.getElementById('modalLng').value = data.address.geo.lng;
                            document.getElementById('modalCompanyName').value = data.company.name;
                            document.getElementById('modalCatchPhrase').value = data.company.catchPhrase;
                            document.getElementById('modalBS').value = data.company.bs;
                            document.getElementById('userModal').style.display = 'block';
                            document.getElementById('modalBackdrop').style.display = 'block';
                            // Reset edit mode if modal reopened
                            isEditMode = false;
                            const formFields = document.querySelectorAll('#userEditForm input');
                            formFields.forEach(input => input.setAttribute('readonly', true));
                            document.getElementById('editUser').textContent = 'Edit';
                        } catch (err) {
                            alert('Could not load user details.');
                            console.error(err);
                        }
                    });
                    userList.appendChild(li);
                });
            } catch (err) {
                alert('Could not load users.');
                console.error(err);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const valOrNA = (id) => {
            const el = document.getElementById(id);
            return el && el.value.trim() !== '' ? el.value.trim() : 'N/A';
    };
                const body = {
                name: document.getElementById('name').value.trim(),
                username: document.getElementById('username').value.trim(),
                email: valOrNA('email'),
                phone: valOrNA('phone'),
                website: valOrNA('website'),
                address: {
                    street: valOrNA('street'),
                    suite: valOrNA('suite'),
                    city: valOrNA('city'),
                    zipcode: valOrNA('zipcode'),
                    geo: {
                        lat: valOrNA('lat'),
                        lng: valOrNA('lng')
                    }
                },
                company: {
                    name: valOrNA('companyName'),
                    catchPhrase: valOrNA('catchPhrase'),
                    bs: valOrNA('bs')
                }
            };

            try {
                const response = await fetch('http://localhost:3000/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.error || 'Something went wrong.'}`);
                    return;
                }

                form.reset();
                fetchUsers();
            } catch (err) {
                alert('Failed to connect to the server.');
                console.error(err);
            }
        });

        fetchUsers();

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
        });
        document.getElementById('modalBackdrop').addEventListener('click', () => {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
        });

        document.getElementById('deleteUser').addEventListener('click', async () => {
            if (!currentUserId) return;
            if (confirm('Are you sure you want to delete this user?')) {
                await fetch(`http://localhost:3000/users/${currentUserId}`, { method: 'DELETE' });
                document.getElementById('userModal').style.display = 'none';
                document.getElementById('modalBackdrop').style.display = 'none';
                fetchUsers();
            }
        });

        let isEditMode = false;

        document.getElementById('editUser').addEventListener('click', async () => {
            const formFields = document.querySelectorAll('#userEditForm input');

            if (!isEditMode) {
                formFields.forEach(input => input.removeAttribute('readonly'));
                document.getElementById('editUser').textContent = 'Save Changes';
                isEditMode = true;
            } else {
                const updatedData = {
                    name: document.getElementById('modalName').value,
                    username: document.getElementById('modalUsername').value,
                    email: document.getElementById('modalEmail').value,
                    phone: document.getElementById('modalPhone').value,
                    website: document.getElementById('modalWebsite').value,
                    address: {
                        street: document.getElementById('modalStreet').value,
                        suite: document.getElementById('modalSuite').value,
                        city: document.getElementById('modalCity').value,
                        zipcode: document.getElementById('modalZipcode').value,
                        geo: {
                            lat: document.getElementById('modalLat').value,
                            lng: document.getElementById('modalLng').value
                        }
                    },
                    company: {
                        name: document.getElementById('modalCompanyName').value,
                        catchPhrase: document.getElementById('modalCatchPhrase').value,
                        bs: document.getElementById('modalBS').value
                    }
                };

                await fetch(`http://localhost:3000/users/${currentUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                formFields.forEach(input => input.setAttribute('readonly', true));
                document.getElementById('editUser').textContent = 'Edit';
                isEditMode = false;
                fetchUsers();
            }
        });
    </script>
</body>
</html>