<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Form</title>
  
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1 id="page-title">HTTP Library Project</h1>
    <h2>Create User</h2>
    <!-- Form to create a new user -->
    <form id="userForm">
        <div id="new-user-info-container">
            <fieldset id="new-user-fieldset">
                <legend>Basic Info</legend>
                <div class="form-field">
                <label for="name">Name:</label>
                <input type="text" id="name" required>
                </div>
        
                <div class="form-field">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
                </div>
                <div class="form-field">
                <label for="email">Email:</label>
                <input type="email" id="email">
                </div>
                <div class="form-field">
                <label for="phone">Phone:</label>
                <input type="text" id="phone">
                </div>
                <div class="form-field">
                <label for="website">Website:</label>
                <input type="text" id="website">
                </div>
            </fieldset>
        
            <fieldset id="new-user-fieldset">
                <legend>Address</legend>
                <div class="form-field">
                <label for="street">Street:</label>
                <input type="text" id="street">
                </div>
                <div class="form-field">
                <label for="suite">Suite:</label>
                <input type="text" id="suite">
                </div>
                <div class="form-field">
                <label for="city">City:</label>
                <input type="text" id="city">
                </div>
                <div class="form-field">
                <label for="zipcode">Zipcode:</label>
                <input type="text" id="zipcode">
                </div>
                <div class="form-field">
                <label for="lat">Latitude:</label>
                <input type="text" id="lat">
                </div>
                <div class="form-field">
                <label for="lng">Longitude:</label>
                <input type="text" id="lng">
                </div>
            </fieldset>
        
            <fieldset id="new-user-fieldset">
                <legend>Company Info</legend>
                <div class="form-field">
                <label for="companyName">Company Name:</label>
                <input type="text" id="companyName">
                </div>
                <div class="form-field">
                <label for="catchPhrase">Catch Phrase:</label>
                <input type="text" id="catchPhrase">
                </div>
                <div class="form-field">
                <label for="bs">BS:</label>
                <input type="text" id="bs">
                </div>
            </fieldset>
        </div>    
        <button id="submit" type="submit" style =margin-top:10px;>Submit</button>
    </form>

    <!-- Display list of all users -->
    <h2>All Users</h2>
    <ul id="userList"></ul>

    <!-- Modal for viewing and editing a selected user -->
    <div id="userModal">
      <div style="display:flex; justify-content:flex-end;">
        <button id="closeModal">X</button>
      </div>
      <div style="display:flex; justify-content: center;"><h2 id="edit-user-title">Edit User</h2></div>
      <div style="padding: 20px;">
        <form id="userEditForm">
          <fieldset>
            <legend>Basic Info:</legend>
            <label>Name: <input type="text" id="modalName" readonly></label><br>
            <label>Username: <input type="text" id="modalUsername" readonly></label><br>
            <label>Email: <input type="text" id="modalEmail" readonly></label><br>
            <label>Phone: <input type="text" id="modalPhone" readonly></label><br>
            <label>Website: <input type="text" id="modalWebsite" readonly></label><br>
          </fieldset>
          <fieldset>
            <legend>Address:</legend>
            <label>Street: <input type="text" id="modalStreet" readonly></label><br>
            <label>Suite: <input type="text" id="modalSuite" readonly></label><br>
            <label>City: <input type="text" id="modalCity" readonly></label><br>
            <label>Zipcode: <input type="text" id="modalZipcode" readonly></label><br>
            <label>Lat: <input type="text" id="modalLat" readonly></label><br>
            <label>Lng: <input type="text" id="modalLng" readonly></label><br>
          </fieldset>
          <fieldset>
            <legend>Company:</legend>
            <label>Name: <input type="text" id="modalCompanyName" readonly></label><br>
            <label>Catch Phrase: <input type="text" id="modalCatchPhrase" readonly></label><br>
            <label>BS: <input type="text" id="modalBS" readonly></label><br>
          </fieldset>
        </form>
        <div style="display:flex; gap:20px; margin-top:10px;">
          <button id="editUser">Edit</button>
          <button id="deleteUser">Delete</button>
        </div>
      </div>
    </div>
    <div id="modalBackdrop" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:999;"></div>
  
    <script>
        const form = document.getElementById('userForm');
        const userList = document.getElementById('userList');
        let currentUserId = null;

        // Fetch all users from the server and render them in the list
        async function fetchUsers() {
            try {
                const res = await fetch('http://localhost:3000/users');
                const data = await res.json();
                userList.innerHTML = '';
                data.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = `${user.name} (${user.username})`;
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', async () => {
                        try {
                            currentUserId = user.id;
                            const res = await fetch(`http://localhost:3000/users/${user.id}`);
                            const data = await res.json();
                            document.getElementById('modalName').value = data.name;
                            document.getElementById('modalUsername').value = data.username;
                            document.getElementById('modalEmail').value = data.email;
                            document.getElementById('modalPhone').value = data.phone;
                            document.getElementById('modalWebsite').value = data.website;
                            document.getElementById('modalStreet').value = data.address.street;
                            document.getElementById('modalSuite').value = data.address.suite;
                            document.getElementById('modalCity').value = data.address.city;
                            document.getElementById('modalZipcode').value = data.address.zipcode;
                            document.getElementById('modalLat').value = data.address.geo.lat;
                            document.getElementById('modalLng').value = data.address.geo.lng;
                            document.getElementById('modalCompanyName').value = data.company.name;
                            document.getElementById('modalCatchPhrase').value = data.company.catchPhrase;
                            document.getElementById('modalBS').value = data.company.bs;
                            document.getElementById('userModal').style.display = 'block';
                            document.getElementById('modalBackdrop').style.display = 'block';
                            // Reset edit mode if modal reopened
                            isEditMode = false;
                            const formFields = document.querySelectorAll('#userEditForm input');
                            formFields.forEach(input => input.setAttribute('readonly', true));
                            document.getElementById('editUser').textContent = 'Edit';
                        } catch (err) {
                            alert('Could not load user details.');
                            console.error(err);
                        }
                    });
                    userList.appendChild(li);
                });
            } catch (err) {
                alert('Could not load users.');
                console.error(err);
            }
        }

        // Handles empty fields by setting them to 'N/A' if not provided
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const valOrNA = (id) => {
            const el = document.getElementById(id);
            return el && el.value.trim() !== '' ? el.value.trim() : 'N/A';
    };
                const body = {
                name: document.getElementById('name').value.trim(),
                username: document.getElementById('username').value.trim(),
                email: valOrNA('email'),
                phone: valOrNA('phone'),
                website: valOrNA('website'),
                address: {
                    street: valOrNA('street'),
                    suite: valOrNA('suite'),
                    city: valOrNA('city'),
                    zipcode: valOrNA('zipcode'),
                    geo: {
                        lat: valOrNA('lat'),
                        lng: valOrNA('lng')
                    }
                },
                company: {
                    name: valOrNA('companyName'),
                    catchPhrase: valOrNA('catchPhrase'),
                    bs: valOrNA('bs')
                }
            };

            try {
                const response = await fetch('http://localhost:3000/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.error || 'Something went wrong.'}`);
                    return;
                }

                form.reset();
                fetchUsers();
            } catch (err) {
                alert('Failed to connect to the server.');
                console.error(err);
            }
        });

        fetchUsers();

        // Close modal 
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
        });
        document.getElementById('modalBackdrop').addEventListener('click', () => {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
        });

        // Handle user deletion
        document.getElementById('deleteUser').addEventListener('click', async () => {
            if (!currentUserId) return;
            if (confirm('Are you sure you want to delete this user?')) {
                await fetch(`http://localhost:3000/users/${currentUserId}`, { method: 'DELETE' });
                document.getElementById('userModal').style.display = 'none';
                document.getElementById('modalBackdrop').style.display = 'none';
                fetchUsers();
            }
        });

        let isEditMode = false;

        // Toggle between edit and save mode for the selected user
        document.getElementById('editUser').addEventListener('click', async () => {
            const formFields = document.querySelectorAll('#userEditForm input');

            if (!isEditMode) {
                formFields.forEach(input => input.removeAttribute('readonly'));
                document.getElementById('editUser').textContent = 'Save Changes';
                isEditMode = true;
            } else {
                const updatedData = {
                    name: document.getElementById('modalName').value,
                    username: document.getElementById('modalUsername').value,
                    email: document.getElementById('modalEmail').value,
                    phone: document.getElementById('modalPhone').value,
                    website: document.getElementById('modalWebsite').value,
                    address: {
                        street: document.getElementById('modalStreet').value,
                        suite: document.getElementById('modalSuite').value,
                        city: document.getElementById('modalCity').value,
                        zipcode: document.getElementById('modalZipcode').value,
                        geo: {
                            lat: document.getElementById('modalLat').value,
                            lng: document.getElementById('modalLng').value
                        }
                    },
                    company: {
                        name: document.getElementById('modalCompanyName').value,
                        catchPhrase: document.getElementById('modalCatchPhrase').value,
                        bs: document.getElementById('modalBS').value
                    }
                };

                await fetch(`http://localhost:3000/users/${currentUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                formFields.forEach(input => input.setAttribute('readonly', true));
                document.getElementById('editUser').textContent = 'Edit';
                isEditMode = false;
                fetchUsers();
            }
        });
    </script>
</body>
</html>